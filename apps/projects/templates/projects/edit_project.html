{% extends "base.html" %}
{% block content %}
  <div class="flex flex-col w-full overflow-y-auto p-6 scrollarea">
    <h1 class="page-title mb-6">Edit project #{{ project.id }}</h1>
    <form method="post" class="space-y-5 text-sm mb-6">
      {% csrf_token %}
      <div>
        <label for="{{ form.title.id_for_label }}" class="form-label">{{ form.title.label }}</label>
        {{ form.title }}
        {% include "form_errors.html" with errors=form.title.errors %}
      </div>
      <div>
        <label for="{{ form.description.id_for_label }}" class="form-label">{{ form.description.label }}</label>
        {{ form.description }}
        {% include "form_errors.html" with errors=form.description.errors %}
      </div>
      <!-- Statuses -->
      <label class="form-label">Statuses</label>
      <!-- Контейнер для статусов -->
      <div id="statuses-container" class="space-y-3 mb-4">
        {% for status in existing_statuses %}
          <div class="status-item flex items-center gap-2">
            <input type="text"
                   name="status_name"
                   value="{{ status.name }}"
                   placeholder="Status name"
                   class="form-input border rounded p-1 w-1/3"
                   required>
            <input type="number"
                   name="status_position"
                   value="{{ status.position }}"
                   class="form-input border rounded p-1 w-1/6"
                   required>
            <button type="button"
                    onclick="this.parentElement.remove()"
                    class="text-red-500">Remove</button>
          </div>
        {% endfor %}
      </div>
      <!-- Кнопка для добавления -->
      <button type="button"
              onclick="addStatus()"
              class="text-sm text-blue-600 mt-2">+ Add status</button>
      <!-- Шаблон для новой строки -->
      <template id="status-template">
        <div class="status-item flex items-center gap-2">
          <input type="text"
                 name="status_name"
                 placeholder="Status name"
                 class="form-input border rounded p-1 w-1/3"
                 required>
          <button type="button"
                  onclick="this.parentElement.remove()"
                  class="text-red-500">-</button>
        </div>
      </template>
      <script>
        function addStatus() {
          const tpl = document.getElementById("status-template");
          const clone = tpl.content.cloneNode(true);
          document.getElementById("statuses-container").appendChild(clone);
        }
      </script>
      <!-- Members -->
      <div>
        <label class="form-label">Members</label>
        {{ member_formset.management_form }}
        <div class="flex flex-wrap gap-2">
          {% for form in member_formset %}
            <div class="member-form border border-gray-300 py-2 rounded flex justify-between"
                 data-deleted="false">
              <span class="block px-3">{{ form.instance.user }}</span>
              {{ form.DELETE }}
              <button type="button"
                      class="remove-btn text-red-500 font-bold px-3"
                      onclick="toggleMemberDelete(this)">-</button>
            </div>
          {% endfor %}
        </div>
      </div>
      <script>
        function toggleMemberDelete(button) {
          const wrapper = button.closest(".member-form");
          const isDeleted = wrapper.dataset.deleted === "true";
          const deleteInput = wrapper.querySelector("input[name$='-DELETE']");

          if (!deleteInput) return;

          if (isDeleted) {
            // Restore
            deleteInput.checked = false;
            wrapper.classList.remove("bg-gray-200", "opacity-60");
            button.textContent = "-";
            button.classList.remove("text-green-500");
            button.classList.add("text-red-500");
            wrapper.dataset.deleted = "false";
          } else {
            // Mark as deleted
            deleteInput.checked = true;
            wrapper.classList.add("bg-gray-200", "opacity-60");
            button.textContent = "+";
            button.classList.remove("text-red-500");
            button.classList.add("text-green-500");
            wrapper.dataset.deleted = "true";
          }
        }
      </script>
      <!-- Submit -->
      <button type="submit"
              class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Save</button>
    </form>
  </div>
{% endblock content %}
