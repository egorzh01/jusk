{% extends "base.html" %}
{% block content %}
  <div class="flex flex-col w-full overflow-y-auto p-6 scrollarea">
    <h1 class="page-title mb-6">Edit project #{{ project.id }}</h1>
    <form method="post" class="space-y-5 text-sm mb-6">
      {% csrf_token %}
      <div>
        <label for="{{ form.title.id_for_label }}" class="form-label">{{ form.title.label }}</label>
        {{ form.title }}
        {% include "form_errors.html" with errors=form.title.errors %}
      </div>
      <div>
        <label for="{{ form.description.id_for_label }}" class="form-label">{{ form.description.label }}</label>
        {{ form.description }}
        {% include "form_errors.html" with errors=form.description.errors %}
      </div>
      <!-- Statuses -->
      <label class="form-label">Statuses</label>
      <div id="statuses-container" class="space-y-3 mb-4">
        {% for status in project.statuses.all %}
          <div class="status-item flex items-center gap-2">
            <input type="text"
                   name="status_names[]"
                   value="{{ status.name }}"
                   placeholder="Status name"
                   class="form-input border rounded p-1 w-1/3"
                   required>
            <button type="button"
                    onclick="this.parentElement.remove()"
                    class="text-red-500">-</button>
          </div>
        {% endfor %}
      </div>
      <!-- Кнопка добавления -->
      <button type="button"
              onclick="addStatus()"
              class="text-sm text-blue-600 mt-2">+ Add status</button>
      <!-- Шаблон -->
      <template id="status-template">
        <div class="status-item flex items-center gap-2">
          <input type="text"
                 name="status_names[]"
                 placeholder="Status name"
                 class="form-input border rounded p-1 w-1/3"
                 required>
          <button type="button"
                  onclick="this.parentElement.remove()"
                  class="text-red-500">-</button>
        </div>
      </template>
      <script>
        function addStatus() {
          const tpl = document.getElementById("status-template");
          const clone = tpl.content.cloneNode(true);
          document.getElementById("statuses-container").appendChild(clone);
        }
      </script>
      <!-- Owner -->
      <div>
        <label class="form-label">Owner</label>
        <div class="w-fit gap-3 flex">
          <span class="border border-gray-300 p-2 rounded">
            {{ project.owner }}
            {% if project.owner_id == request.user.id %}(You){% endif %}
          </span>
          {% if project.owner_id == request.user.id %}
            <svg xmlns="http://www.w3.org/2000/svg"
                 fill="none"
                 viewBox="0 0 24 24"
                 stroke-width="1.5"
                 stroke="currentColor"
                 class="size-5 self-center">
              <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99" />
            </svg>
          {% endif %}
        </div>
      </div>
      <!-- Members -->
      <label class="form-label">Members</label>
      <div class="flex flex-wrap gap-2" id="members-container">
        {% for member in project.members.all %}
          <div class="member-form border border-gray-300 py-2 rounded flex justify-between items-center"
               data-id="{{ member.id }}">
            <span class="block px-3">{{ member.user }}
              {% if member.user_id == request.user.id %}(You){% endif %}
            </span>
            <input type="hidden" name="member_ids[]" value="{{ member.id }}">
            {% if project.owner_id != member.user_id %}
              <button type="button"
                      class="remove-btn text-red-500 font-bold px-3"
                      onclick="toggleMemberDelete(this)">-</button>
            {% endif %}
          </div>
        {% endfor %}
      </div>
      <script>
        function toggleMemberDelete(button) {
          const wrapper = button.closest(".member-form");
          const isDeleted = wrapper.dataset.deleted === "true";

          if (isDeleted) {
            wrapper.dataset.deleted = "false";
            wrapper.classList.remove("bg-gray-200", "opacity-60");
            button.textContent = "-";
            button.classList.remove("text-green-500");
            button.classList.add("text-red-500");

            const newInput = document.createElement("input");
            newInput.type = "hidden";
            newInput.name = "member_ids[]";
            newInput.value = memberId;
            wrapper.appendChild(newInput);
          } else {
            wrapper.dataset.deleted = "true";
            wrapper.classList.add("bg-gray-200", "opacity-60");
            button.textContent = "+";
            button.classList.remove("text-red-500");
            button.classList.add("text-green-500");

            const hiddenInput = wrapper.querySelector(`input[type="hidden"][name="member_ids[]"]`);
            if (hiddenInput) {
              hiddenInput.remove();
            }
          }
        }
      </script>
      <!-- Submit -->
      <div class="flex flex-row gap-15">
        <button type="submit"
                class="rounded border border-gray-300 p-1 hover:bg-gray-300 font-medium">Save</button>
        <button type="button"
                onclick="window.history.back();"
                class="rounded border border-gray-300 p-1 hover:bg-gray-300 font-medium text-red-500">Cancel</button>
      </div>
    </form>
  </div>
{% endblock content %}
